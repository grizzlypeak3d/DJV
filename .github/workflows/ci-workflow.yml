name: CI

on: [push]

jobs:
  linux-build:
    runs-on: ubuntu-latest

    env:
      JOBS: 4
      DJV_MACOS_PACKAGE: OFF
      TLRENDER_NET: OFF
      TLRENDER_OCIO: ON
      TLRENDER_JPEG: ON
      TLRENDER_TIFF: ON
      TLRENDER_EXR: ON
      TLRENDER_FFMPEG: ON
      TLRENDER_FFMPEG_MINIMAL: ON
      TLRENDER_OIIO: ON
      TLRENDER_USD: OFF
      TLRENDER_BMD: OFF
      TLRENDER_BMD_SDK:
      FTK_API: GL_4_1
      BUILD_SHARED_LIBS: OFF

    steps:
    - uses: actions/checkout@v4
      with:
        path: DJV
        submodules: recursive
    - uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Setup environment
      run: |
        echo "$PWD/install-Debug/bin" >> $GITHUB_PATH
        echo "LD_LIBRARY_PATH=$PWD/install-Debug/lib:$LD_LIBRARY_PATH" >> $GITHUB_ENV
        echo "PYTHONPATH=$PWD/install-Debug/lib:$PYTHONPATH" >> $GITHUB_ENV
        cmake --version
        python --version
        sh DJV/etc/Linux/linux-setup-gha.sh

    - name: Super Build
      run: sh DJV/etc/Linux/linux-sbuild.sh Debug

    - name: Build DJV
      run: sh DJV/etc/Linux/linux-build.sh Debug

  # \bug Disable building OIIO; it seems there is an error when OCIO is disabled.
  linux-gles2-build:
    runs-on: ubuntu-latest

    env:
      JOBS: 4
      DJV_MACOS_PACKAGE: OFF
      TLRENDER_NET: OFF
      TLRENDER_OCIO: OFF
      TLRENDER_JPEG: ON
      TLRENDER_TIFF: ON
      TLRENDER_EXR: ON
      TLRENDER_FFMPEG: OFF
      TLRENDER_FFMPEG_MINIMAL: ON
      TLRENDER_OIIO: OFF
      TLRENDER_USD: OFF
      TLRENDER_BMD: OFF
      TLRENDER_BMD_SDK:
      FTK_API: GLES_2

    steps:
    - uses: actions/checkout@v4
      with:
        path: DJV
        submodules: recursive
    - uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Setup environment
      run: |
        echo "$PWD/install-Debug/bin" >> $GITHUB_PATH
        echo "LD_LIBRARY_PATH=$PWD/install-Debug/lib:$LD_LIBRARY_PATH" >> $GITHUB_ENV
        echo "PYTHONPATH=$PWD/install-Debug/lib:$PYTHONPATH" >> $GITHUB_ENV
        cmake --version
        python --version
        python --version
        sh DJV/etc/Linux/linux-setup-gha.sh

    - name: Super Build
      run: sh DJV/etc/Linux/linux-sbuild.sh Debug

    - name: Build DJV
      run: sh DJV/etc/Linux/linux-build.sh Debug

  linux-package:
    runs-on: ubuntu-22.04

    env:
      JOBS: 4
      DJV_MACOS_PACKAGE: OFF
      TLRENDER_NET: OFF
      TLRENDER_OCIO: ON
      TLRENDER_JPEG: ON
      TLRENDER_TIFF: ON
      TLRENDER_EXR: ON
      TLRENDER_FFMPEG: ON
      TLRENDER_FFMPEG_MINIMAL: ON
      TLRENDER_OIIO: ON
      TLRENDER_USD: ON
      TLRENDER_BMD: OFF
      TLRENDER_BMD_SDK:
      FTK_API: GL_4_1
      BUILD_SHARED_LIBS: OFF

    steps:
    - uses: actions/checkout@v4
      with:
        path: DJV
        submodules: recursive
    - uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Setup environment
      run: |
        echo "$PWD/install-Release/bin" >> $GITHUB_PATH
        echo "LD_LIBRARY_PATH=$PWD/install-Release/lib:$LD_LIBRARY_PATH" >> $GITHUB_ENV
        echo "PYTHONPATH=$PWD/install-Release/lib:$PYTHONPATH" >> $GITHUB_ENV
        cmake --version
        python --version
        python --version
        sh DJV/etc/Linux/linux-setup-gha.sh

    - name: Super Build
      run: sh DJV/etc/Linux/linux-sbuild.sh Release

    - name: Build and package DJV
      run: sh DJV/etc/Linux/linux-package.sh Release

    - uses: actions/upload-artifact@v4
      with:
        name: DJV-Linux-Packages
        path: build-Release/DJV-*.tar.gz

  macos-build:
    runs-on: macos-latest

    env:
      JOBS: 4
      DJV_MACOS_PACKAGE: OFF
      TLRENDER_NET: OFF
      TLRENDER_OCIO: ON
      TLRENDER_JPEG: ON
      TLRENDER_TIFF: ON
      TLRENDER_EXR: ON
      TLRENDER_FFMPEG: ON
      TLRENDER_FFMPEG_MINIMAL: ON
      TLRENDER_OIIO: ON
      TLRENDER_USD: OFF
      TLRENDER_BMD: OFF
      TLRENDER_BMD_SDK:
      FTK_API: GL_4_1
      BUILD_SHARED_LIBS: OFF
      CMAKE_OSX_DEPLOYMENT_TARGET: 14
      CMAKE_OSX_ARCHITECTURES: arm64

    steps:
    - uses: actions/checkout@v4
      with:
        path: DJV
        submodules: recursive
    - uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    # \bug DYLD_LIBRARY_PATH is not being set here?
    - name: Setup environment
      run: |
        echo "$PWD/install-Debug/bin" >> $GITHUB_PATH
        echo "DYLD_LIBRARY_PATH=$PWD/install-Debug/lib:$DYLD_LIBRARY_PATH" >> $GITHUB_ENV
        echo "PYTHONPATH=$PWD/install-Debug/lib:$PYTHONPATH" >> $GITHUB_ENV
        cmake --version
        python --version

    - name: Super Build
      run: |
        export DYLD_LIBRARY_PATH=$PWD/install-Debug/lib:$DYLD_LIBRARY_PATH
        sh DJV/etc/macOS/macos-sbuild.sh Debug

    - name: Build DJV
      run: |
        export DYLD_LIBRARY_PATH=$PWD/install-Debug/lib:$DYLD_LIBRARY_PATH
        sh DJV/etc/macOS/macos-build.sh Debug

  macos-package:
    runs-on: macos-latest

    env:
      JOBS: 4
      DJV_MACOS_PACKAGE: ON
      TLRENDER_NET: OFF
      TLRENDER_OCIO: ON
      TLRENDER_JPEG: ON
      TLRENDER_TIFF: ON
      TLRENDER_EXR: ON
      TLRENDER_FFMPEG: ON
      TLRENDER_FFMPEG_MINIMAL: ON
      TLRENDER_OIIO: ON
      TLRENDER_USD: ON
      TLRENDER_BMD: OFF
      TLRENDER_BMD_SDK:
      FTK_API: GL_4_1
      BUILD_SHARED_LIBS: OFF
      CMAKE_OSX_DEPLOYMENT_TARGET: 10.15
      CMAKE_OSX_ARCHITECTURES: arm64

    steps:
    - uses: actions/checkout@v4
      with:
        path: DJV
        submodules: recursive
    - uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    # \bug DYLD_LIBRARY_PATH is not being set here?
    - name: Setup environment
      run: |
        echo "$PWD/install-Release/bin" >> $GITHUB_PATH
        echo "DYLD_LIBRARY_PATH=$PWD/install-Release/lib:$DYLD_LIBRARY_PATH" >> $GITHUB_ENV
        echo "PYTHONPATH=$PWD/install-Release/lib:$PYTHONPATH" >> $GITHUB_ENV
        cmake --version
        python --version

    - name: Super Build
      run: |
        export DYLD_LIBRARY_PATH=$PWD/install-Release/lib:$DYLD_LIBRARY_PATH
        sh DJV/etc/macOS/macos-sbuild.sh Release

    # \bug Sometimes the CI runs out of disk space when building the macOS
    # package, so free some up by removing the super build directory.
    - name: Package
      run: |
        rm -rf sbuild-Release
        export DYLD_LIBRARY_PATH=$PWD/install-Release/lib:$DYLD_LIBRARY_PATH
        sh DJV/etc/macOS/macos-package.sh Release

    - uses: actions/upload-artifact@v4
      with:
        name: DJV-macOS-Packages
        path: build-Release/DJV-*.dmg

  windows-build:
    runs-on: windows-latest

    env:
      JOBS: 4
      DJV_MACOS_PACKAGE: OFF
      TLRENDER_NET: OFF
      TLRENDER_OCIO: ON
      TLRENDER_JPEG: ON
      TLRENDER_TIFF: ON
      TLRENDER_EXR: ON
      TLRENDER_FFMPEG: ON
      TLRENDER_FFMPEG_MINIMAL: ON
      TLRENDER_OIIO: ON
      TLRENDER_USD: OFF
      TLRENDER_BMD: OFF
      TLRENDER_BMD_SDK:
      FTK_API: GL_4_1
      BUILD_SHARED_LIBS: OFF

    steps:
    - uses: actions/checkout@v4
      with:
        path: DJV
        submodules: recursive
    - uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    - uses: ilammy/setup-nasm@v1

    # \bug Any spaces before the ">>" will be considered part of the path.
    - name: Setup environment
      shell: cmd
      run: |
        echo %CD%\install-Debug\bin>> %GITHUB_PATH%
        echo %CD%\install-Debug\lib>> %GITHUB_PATH%
        echo CTEST_OUTPUT_ON_FAILURE=1 >> %GITHUB_ENV%
        cmake --version
        python --version
        
    - name: Super Build
      shell: cmd
      run: DJV\etc\Windows\windows-sbuild.bat Debug

    - name: Build DJV
      shell: cmd
      run: DJV\etc\Windows\windows-build.bat Debug

  windows-package:
    runs-on: windows-latest

    env:
      JOBS: 4
      DJV_MACOS_PACKAGE: OFF
      TLRENDER_NET: OFF
      TLRENDER_OCIO: ON
      TLRENDER_JPEG: ON
      TLRENDER_TIFF: ON
      TLRENDER_EXR: ON
      TLRENDER_FFMPEG: ON
      TLRENDER_FFMPEG_MINIMAL: ON
      TLRENDER_OIIO: ON
      TLRENDER_USD: ON
      TLRENDER_BMD: OFF
      TLRENDER_BMD_SDK:
      FTK_API: GL_4_1
      BUILD_SHARED_LIBS: OFF

    steps:
    - uses: actions/checkout@v4
      with:
        path: DJV
        submodules: recursive
    - uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    - uses: ilammy/setup-nasm@v1

    # \bug Any spaces before the ">>" will be considered part of the path.
    - name: Setup environment
      shell: cmd
      run: |
        echo %CD%\install-Release\bin>> %GITHUB_PATH%
        echo %CD%\install-Release\lib>> %GITHUB_PATH%
        echo CTEST_OUTPUT_ON_FAILURE=1 >> %GITHUB_ENV%
        cmake --version
        python --version
        winget install NSIS.NSIS --accept-package-agreements --accept-source-agreements --disable-interactivity

    - name: Super Build
      shell: cmd
      run: DJV\etc\Windows\windows-sbuild.bat Release

    - name: Build and package DJV
      shell: cmd
      run: DJV\etc\Windows\windows-package.bat Release

    - uses: actions/upload-artifact@v4
      with:
        name: DJV-Windows-Packages
        path: |
          build-Release\DJV-*.exe
          build-Release\DJV-*.zip
